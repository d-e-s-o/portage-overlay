From 8676930120b58e34fac40acd9b2e9417a08f5b0e Mon Sep 17 00:00:00 2001
From: deso <deso@devnull.com>
Date: Sat, 23 Feb 2013 08:34:01 -0800
Subject: [PATCH 4/6] added better "current working directory" support for tabs

---
 src/perl/tabbed | 17 ++++++++++++++++-
 src/rxvtperl.xs |  9 +++++++++
 src/typemap     |  5 +++++
 3 files changed, 30 insertions(+), 1 deletion(-)

diff --git a/src/perl/tabbed b/src/perl/tabbed
index dd20a8d..6511474 100644
--- a/src/perl/tabbed
+++ b/src/perl/tabbed
@@ -426,7 +426,22 @@ sub tab_key_press {
       }
       elsif ($keysym == $key_n)
       {
-         $self->new_tab;
+         # on Linux /proc/<pid>/cwd is a symlink pointing to the current working directory of the
+         # process with id <pid>
+         my $cwd = "/proc/" . $self->{cur}->get_pid() . "/cwd";
+
+         if (-l $cwd)
+         {
+            my @argv;
+            push(@argv, "-cd");
+            push(@argv, readlink($cwd));
+
+            $self->new_tab (@argv);
+         }
+         else
+         {
+            $self->new_tab;
+         }
          return 1;
       }
       elsif (exists $tab_index{$keysym})
diff --git a/src/rxvtperl.xs b/src/rxvtperl.xs
index 92ad48c..acfc4e9 100644
--- a/src/rxvtperl.xs
+++ b/src/rxvtperl.xs
@@ -1304,6 +1304,15 @@ rxvt_term::strwidth (SV *str)
 	OUTPUT:
         RETVAL
 
+pid_t
+rxvt_term::get_pid()
+    CODE:
+    {
+      RETVAL = THIS->cmd_pid;
+    }
+    OUTPUT:
+    RETVAL
+
 SV *
 rxvt_term::locale_encode (SV *str)
 	CODE:
diff --git a/src/typemap b/src/typemap
index 8ad9f12..fef4037 100644
--- a/src/typemap
+++ b/src/typemap
@@ -4,6 +4,11 @@ Time			T_UV
 Atom			T_UV
 Window			T_UV
 Pixmap			T_UV
+
+# pid_t is no registered type in my perl distribution, thus we need to register it here
+# according to /usr/include/bits/typesizes.h it is a signed type, so we declare it this way
+pid_t			T_IV
+
 rxvt_img::nv		T_NV
 
 urxvt::pixbuf           T_PTROBJ
-- 
2.0.4

